<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Продвинутые крестики-нолики</title>

<style>
:root {
    --bg: #1e1e2f;
    --cell: #2e2e4f;
    --hover: #4e4e8f;
    --text: white;
}

body {
    margin: 0;
    font-family: Arial;
    text-align: center;
    background: var(--bg);
    color: var(--text);
}

h1 { margin-top: 20px; }

.controls {
    margin: 15px;
}

select, button {
    padding: 8px;
    margin: 5px;
    border-radius: 8px;
    border: none;
}

#board {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    gap: 5px;
    justify-content: center;
    margin-top: 20px;
}

.cell {
    width: 100px;
    height: 100px;
    font-size: 40px;
    background: var(--cell);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 12px;
    transition: 0.2s;
}

.cell:hover {
    background: var(--hover);
}

.theme-light {
    --bg: #f4f4f4;
    --cell: #ffffff;
    --hover: #ddd;
    --text: black;
}

.theme-neon {
    --bg: black;
    --cell: #111;
    --hover: #0ff;
    --text: #0ff;
}
</style>
</head>
<body>

<h1>Крестики-нолики 2.0</h1>

<div class="controls">
    Сложность:
    <select id="difficulty">
        <option value="easy">Лёгкий</option>
        <option value="medium">Средний</option>
        <option value="hard">Сложный</option>
        <option value="learning">Самообучающийся</option>
    </select>

    Тема:
    <select id="theme">
        <option value="">Тёмная</option>
        <option value="theme-light">Светлая</option>
        <option value="theme-neon">Неон</option>
    </select>

    <button onclick="restart()">Новая игра</button>
</div>

<h2 id="status">Твой ход</h2>
<div id="board"></div>

<script>
const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");
const difficultySelect = document.getElementById("difficulty");
const themeSelect = document.getElementById("theme");

let board = Array(9).fill("");
let gameOver = false;

let memory = JSON.parse(localStorage.getItem("aiMemory") || "{}");

function saveMemory() {
    localStorage.setItem("aiMemory", JSON.stringify(memory));
}

function drawBoard() {
    boardEl.innerHTML = "";
    board.forEach((cell, i) => {
        const div = document.createElement("div");
        div.className = "cell";
        div.innerText = cell;
        div.onclick = () => playerMove(i);
        boardEl.appendChild(div);
    });
}

function playerMove(i) {
    if (board[i] || gameOver) return;
    board[i] = "X";
    drawBoard();

    if (checkWinner("X")) return endGame("Ты победил!");

    if (isDraw()) return endGame("Ничья!");

    setTimeout(aiMove, 300);
}

function aiMove() {
    let difficulty = difficultySelect.value;

    let move;
    if (difficulty === "easy") {
        move = randomMove();
    } 
    else if (difficulty === "medium") {
        move = Math.random() < 0.5 ? randomMove() : bestMove();
    } 
    else if (difficulty === "hard") {
        move = bestMove();
    } 
    else {
        move = learningMove();
    }

    board[move] = "O";
    drawBoard();

    if (checkWinner("O")) return endGame("ИИ победил!");
    if (isDraw()) return endGame("Ничья!");

    statusEl.innerText = "Твой ход";
}

function randomMove() {
    let empty = board.map((v,i)=>v===""?i:null).filter(v=>v!==null);
    return empty[Math.floor(Math.random()*empty.length)];
}

function bestMove() {
    let bestScore = -Infinity;
    let move;
    for (let i=0;i<9;i++) {
        if (!board[i]) {
            board[i] = "O";
            let score = minimax(board, 0, false);
            board[i] = "";
            if (score > bestScore) {
                bestScore = score;
                move = i;
            }
        }
    }
    return move;
}

function minimax(b, depth, isMax) {
    if (checkWinner("O")) return 10-depth;
    if (checkWinner("X")) return depth-10;
    if (isDraw()) return 0;

    if (isMax) {
        let best=-Infinity;
        for (let i=0;i<9;i++){
            if(!b[i]){
                b[i]="O";
                best=Math.max(best,minimax(b,depth+1,false));
                b[i]="";
            }
        }
        return best;
    } else {
        let best=Infinity;
        for (let i=0;i<9;i++){
            if(!b[i]){
                b[i]="X";
                best=Math.min(best,minimax(b,depth+1,true));
                b[i]="";
            }
        }
        return best;
    }
}

function learningMove() {
    let state = board.join("");
    let moves = memory[state];

    if (moves) {
        let sorted = Object.entries(moves).sort((a,b)=>b[1]-a[1]);
        for (let [pos] of sorted) {
            if (!board[pos]) return parseInt(pos);
        }
    }

    return randomMove();
}

function learn(result) {
    if (difficultySelect.value !== "learning") return;

    let state = board.join("");
    if (!memory[state]) memory[state] = {};

    board.forEach((cell, i) => {
        if (cell === "O") {
            memory[state][i] = (memory[state][i] || 0) + (result==="win"?2:result==="draw"?1:-1);
        }
    });

    saveMemory();
}

function checkWinner(player) {
    const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    return wins.some(w=>w.every(i=>board[i]===player));
}

function isDraw() {
    return board.every(c=>c);
}

function endGame(msg) {
    statusEl.innerText = msg;
    gameOver = true;

    if (msg.includes("ИИ победил")) learn("win");
    else if (msg.includes("Ничья")) learn("draw");
    else learn("lose");
}

function restart() {
    board = Array(9).fill("");
    gameOver = false;
    statusEl.innerText = "Твой ход";
    drawBoard();
}

themeSelect.onchange = () => {
    document.body.className = themeSelect.value;
};

drawBoard();
</script>
</body>
</html>
